---
- name: Run Tower Configuration
  hosts: localhost
  gather_facts: False
  vars:
    organizations:
      - "Org 1"
      - "Org 2"
  collections:
    - awx.awx

  tasks:
    - name: Create Organizations
      tower_organization:
        name: "{{ item }}"
      loop: "{{ organizations }}"

    - name: Create Foo Projects
      tower_project:
        name: "Foo"
        organization: "{{ item }}"
        scm_type: 'git'
        scm_url: 'https://github.com/john-westcott-iv/ansiblefest2020'
        scm_update_on_launch: true
      loop: "{{ organizations }}"

    - name: Configue Tower Settings
      tower_settings:
        settings: "{{ lookup('file', 'files/custom_settings.json') | from_json() }}"

    - name: Create a snafu user
      tower_user:
        username: "snafu"
        first_name: "sna"
        last_name: "fu"
        email: "snafu@example.org"
        password: "snafoo123!"

    - name: "Add snafu user to {{ organizations[0] }}"
      tower_role:
        user: "snafu"
        role: "member"
        organization: "{{ organizations[0] }}"

    - name: Add org1admin user
      tower_user:
        username: "org1admin"
        first_name: "org1"
        last_name: "admin"
        email: "admin@org1.example.org"
        password: "org1admin"

    - name: "Make org1admin an admin of {{ organizations[0] }}"
      tower_role:
        user: "org1admin"
        role: "admin"
        organization: "{{ organizations[0] }}"
      
